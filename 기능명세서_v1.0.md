# 다국어 QR 테이블 주문 서비스 상세 기능명세서 v1.0

------------------------------------------------------------------------

## 0. 문서 정보

-   **문서 목적**: 개발(프론트/백엔드/QA) 착수용 상세 명세 제공\
-   **대상**: 점주(관리자), 매장 직원(옵션), 고객(테이블 이용자)\
-   **채널**: 고객용 Web(PWA 권장), 점주용 Admin Web, (옵션) 점주용
    Tablet 뷰\
-   **핵심 차별**: 테이블별 QR + 공유 장바구니 + 실시간 동기화 + 다국어
    메뉴/주문

------------------------------------------------------------------------

## 1. 용어 정의

-   **Store(매장)**: 점주가 운영하는 단위\
-   **Table(테이블)**: 매장 내 좌석 단위\
-   **Table QR**: 테이블별 고유 QR(같은 테이블 사람은 동일 QR 사용)\
-   **Table Session(테이블 세션)**: 테이블 QR로 입장한 사용자들이
    공유하는 주문/카트 컨텍스트\
-   **Participant(참여자)**: 테이블 세션에 접속한 사용자(브라우저 단위)\
-   **Shared Cart(공유 장바구니)**: 테이블 세션에 종속된 공동 장바구니\
-   **Order(주문)**: 공유 장바구니를 확정하여 생성된 주문 문서\
-   **Order Round(주문 라운드)**: 동일 세션에서 추가 주문 발생 시
    구분(1차, 2차...)\
-   **Menu Locale(다국어 텍스트)**: 메뉴명/설명/알레르기 등 다국어 버전

------------------------------------------------------------------------

## 2. 사용자/권한 모델

### 2.1 사용자 유형

#### Owner(점주)

-   매장 생성/관리
-   메뉴 관리
-   주문 처리
-   결제 설정
-   직원 관리(옵션)

#### Staff(직원, 옵션)

-   주문 처리/상태 변경
-   세션 종료 가능
-   (세부 권한 분리 가능)

#### Customer(고객)

-   테이블 QR 접속
-   메뉴 조회
-   공유 장바구니 편집
-   주문 생성
-   결제(옵션)

### 2.2 권한 정책(요약)

-   Owner: 전체 권한
-   Staff: 주문/세션/테이블 운영 기능
-   Customer: 본인이 입장한 테이블 세션 범위 내 장바구니/주문

------------------------------------------------------------------------

## 3. 공통 요구사항

### 3.1 다국어(i18n/l10n)

-   기기 언어 자동 감지 → 미지원 시 기본값 적용
-   UI에서 언어 전환 가능
-   번역 대상:
    -   카테고리명
    -   메뉴명/설명
    -   옵션명/옵션값
    -   알레르기/필터 라벨
    -   문화 설명
-   자동 번역 + 점주 수정 가능
-   숫자/통화/시간은 locale 기반 표시 (저장은 표준화)

### 3.2 접근 방식

-   고객: QR → 웹 접속 (앱 설치 불필요)
-   점주: Web Admin (PC/Tablet)

### 3.3 개인정보 최소화

-   로그인 없이 세션 기반 사용
-   닉네임 입력 선택
-   PG 도입 시 민감정보 저장 금지

------------------------------------------------------------------------

## 4. 핵심 데이터 모델(개념)

### 4.1 Store

-   store_id (PK)
-   owner_id
-   name, address, phone
-   business_hours
-   default_language
-   supported_languages\[\]
-   settings:
    -   order_confirm_mode (ANYONE / HOST_ONLY / CONSENSUS)
    -   session_ttl_minutes (기본 180)
    -   allow_split_payment (T/F)
    -   allow_additional_orders (T/F)
    -   service_charge_policy
    -   tax_included

### 4.2 Table

-   table_id (PK)
-   store_id (FK)
-   table_number
-   qr_token_version
-   status (ACTIVE/INACTIVE)

### 4.3 TableSession

-   session_id (PK)
-   store_id, table_id
-   status (OPEN/CLOSED/EXPIRED)
-   created_at, last_activity_at, closed_at
-   current_round_no
-   host_participant_id
-   participants_count

### 4.4 Participant

-   participant_id (PK)
-   session_id
-   nickname
-   device_fingerprint_hash
-   joined_at, last_seen_at
-   role_in_session (HOST/GUEST)

### 4.5 Menu

-   menu_id (PK)
-   store_id
-   category_id
-   base_price
-   images\[\]
-   flags (is_sold_out, is_recommended, is_hidden)
-   dietary_tags
-   spiciness_level (1\~5)
-   challenge_level (1\~5)
-   allergens\[\]
-   locales { lang: { name, description, cultural_note } }
-   options\[\]

### 4.6 SharedCart

-   cart_id (PK)
-   session_id
-   updated_at
-   version

### 4.7 Order

-   order_id (PK)
-   store_id, table_id, session_id
-   round_no
-   status
-   items\[\] (snapshot)
-   totals (subtotal, tax, service_charge, grand_total)
-   payment_status
-   placed_at

------------------------------------------------------------------------

## 5. 고객(Web) 기능

### 5.1 테이블 QR 접속

-   QR 검증 후 OPEN 세션 참여 또는 신규 생성
-   무효 QR → 오류 메시지
-   동일 브라우저 재접속 시 participant 재사용
-   동일 QR 다수 접속 시 동일 세션 공유

### 5.2 메뉴 탐색

-   카테고리/검색/필터
-   상세에서 옵션 선택 후 장바구니 담기
-   알레르기/맵기/도전 난이도 표시

### 5.3 공유 장바구니

-   실시간 동기화(WebSocket/SSE)
-   낙관적 락(version 기반)
-   충돌 시 최신 카트 반환 + 토스트 안내
-   동일 옵션 조합은 merge
-   2인 이상 동시 수정 시 누락 없음

### 5.4 주문 생성

-   idempotency_key 지원
-   가격 스냅샷 저장
-   품절 검증
-   확정 모드: ANYONE / HOST_ONLY / CONSENSUS

### 5.5 주문 상태 조회

-   타임라인: PLACED → ACCEPTED → COOKING → READY → SERVED
-   실시간 상태 반영

------------------------------------------------------------------------

## 6. 점주(Admin) 기능

### 6.1 인증

-   이메일 로그인
-   비밀번호 재설정
-   2FA(옵션)

### 6.2 매장/테이블 관리

-   매장 설정
-   테이블 일괄 생성
-   QR 출력(PDF)
-   QR 재발급(버전 증가 → 기존 무효화)

### 6.3 메뉴 관리

-   카테고리 CRUD
-   메뉴 CRUD
-   옵션 그룹 관리
-   번역 자동 생성 및 수정
-   관광 특화 필드 관리

### 6.4 주문 관리

-   실시간 주문 대시보드
-   상태 변경 (ACCEPTED / COOKING / READY / SERVED / CANCELLED)
-   세션 종료 기능

### 6.5 통계

-   매출
-   인기 메뉴
-   언어 사용 비중
-   맵기/도전 난이도별 판매량

------------------------------------------------------------------------

## 7. API 명세(요약)

### Public API

-   POST /api/public/table-sessions/join
-   GET /api/public/stores/{store_id}/menu
-   POST /api/public/carts/{cart_id}/mutations
-   POST /api/public/table-sessions/{session_id}/orders

### Admin API

-   POST /api/admin/stores
-   PATCH /api/admin/menus/{menu_id}
-   GET /api/admin/stores/{store_id}/orders
-   PATCH /api/admin/orders/{order_id}/status

------------------------------------------------------------------------

## 8. 실시간 이벤트

-   CART_UPDATED
-   ORDER_PLACED
-   ORDER_STATUS_CHANGED
-   SESSION_CLOSED

------------------------------------------------------------------------

## 9. 보안

-   QR 토큰 서명 기반 위조 방지
-   Admin RBAC
-   고객 API rate limit
-   session_id scope 검증 필수

------------------------------------------------------------------------

## 10. MVP 범위 (v1.0)

-   QR 입장
-   공유 카트
-   주문 전송
-   점주 주문 대시보드
-   다국어 메뉴
-   알레르기/맵기/도전난이도 표시

------------------------------------------------------------------------

## 11. v1.1 예정

-   PG 선결제
-   분할 결제
-   쿠폰/프로모션
-   POS 연동

------------------------------------------------------------------------

## 12. 개발 체크리스트

-   [ ] QR 서명/검증/재발급
-   [ ] 세션 TTL/종료 처리
-   [ ] 낙관적 락 기반 공유 카트
-   [ ] 실시간 이벤트 처리
-   [ ] 주문 스냅샷/멱등성
-   [ ] 다국어 편집 UI
-   [ ] 관광 특화 필드 지원
-   [ ] Admin 태블릿 UX 최적화
-   [ ] QA 자동화(충돌/끊김/품절)

------------------------------------------------------------------------

**End of Document**
